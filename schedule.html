<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Schedule</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="media_queries.css">
    <link rel="stylesheet" href="schedule_style.css">
</head>
<body>
    <div class="dashboard-container" id="dashboardContainer">
        <main class="main-content">
            <header class="header-top">
                <button class="mobile-menu-toggle" id="mobileMenuToggle">
                    <i class='bx bx-menu'></i>
                </button>
                <div class="header-greeting">
                    <h1>My Schedule</h1>
                </div>
            </header>

            <section class="schedule-list-section">
                <div class="schedule-list-header">
                    <h2>Upcoming Schedules</h2>
                    <button type="button" id="openAddScheduleModalButton" title="Add Schedule" class="add-schedule-btn">
                        <i class='bx bx-plus'></i> Add Schedule
                    </button>
                </div>
                <div class="schedule-list" id="scheduleList">
                    </div>
            </section>

            <div class="modal-overlay" id="addScheduleModal" style="display: none;">
                <div class="form-container">
                    <div class="form-header">
                        <h2 id="formTitle">Add New Schedule</h2>
                        <button type="button" class="close-button" id="closeAddScheduleModalButton" aria-label="Close Modal">&times;</button>
                    </div>
                    <form class="form-body" id="scheduleForm">
                        <input type="hidden" id="scheduleId" /> <div class="form-group">
                            <label for="title">Title</label>
                            <input type="text" id="title" name="title" required autocomplete="off" placeholder="Enter schedule title" />
                        </div>
                        
                        <div class="form-group input-with-icon">
                            <label for="dateDisplay">Date</label>
                            <input type="text" id="dateDisplay" name="dateDisplay" required placeholder="Select date" readonly />
                            <i class="bx bx-calendar calendar-icon"></i>
                            <input type="date" id="dateInput" name="dateInput" class="hidden-date-input" /> </div>
                        
                        <div class="form-group input-with-icon">
                            <label for="startTimeDisplay">Start Time</label>
                            <div class="time-picker-wrapper">
                                <input type="text" id="startTimeDisplay" name="startTimeDisplay" required placeholder="Select start time" readonly />
                                <i class="bx bx-time-five time-icon"></i>
                                <input type="time" id="startTimeInput" name="startTimeInput" class="hidden-time-input" /> </div>
                        </div>
                        
                        <div class="form-group input-with-icon">
                            <label for="endTimeDisplay">End Time</label>
                            <div class="time-picker-wrapper">
                                <input type="text" id="endTimeDisplay" name="endTimeDisplay" required placeholder="Select end time" readonly />
                                <i class="bx bx-time-five time-icon"></i>
                                <input type="time" id="endTimeInput" name="endTimeInput" class="hidden-time-input" /> </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="statusColor">Category Color</label>
                            <div class="custom-select-wrapper">
                                <select id="statusColor" name="statusColor" required class="styled-select">
                                    <option value="blue" selected>Blue (General)</option>
                                    <option value="green">Green (Meeting)</option>
                                    <option value="red">Red (Urgent)</option>
                                    <option value="purple">Purple (Personal)</option>
                                </select>
                                <i class="fas fa-chevron-down select-arrow"></i>
                            </div>
                        </div>
                        
                        <div class="form-buttons" style="display: flex; justify-content: space-between;">
                            <button type="button" id="cancelEditButton" class="cancel-button" style="display:none;">Cancel Edit</button>
                            <button type="submit" id="saveScheduleButton" class="vibrant-button">Add Schedule</button>
                        </div>
                    </form>
                </div>
            </div>
            </main>

        <aside class="sidebar-right">
            <section class="calendar-section">
                <div class="calendar-header">
                    <button class="nav-arrows" id="prevMonthBtn"><i class='bx bx-chevron-left'></i></button>
                    <h3 id="currentMonthYear">October 2023</h3>
                    <button class="nav-arrows" id="nextMonthBtn"><i class='bx bx-chevron-right'></i></button>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                    <div class="calendar-weekday">Mon</div>
                    <div class="calendar-weekday">Tue</div>
                    <div class="calendar-weekday">Wed</div>
                    <div class="calendar-weekday">Thu</div>
                    <div class="calendar-weekday">Fri</div>
                    <div class="calendar-weekday">Sat</div>
                    <div class="calendar-weekday">Sun</div>
                </div>
            </section>

            <section class="today-schedule-section">
                <div class="section-header">
                    <h2>Today Schedule</h2>
                    <button class="icon-button"><i class='bx bx-dots-vertical-rounded'></i></button>
                </div>
                <div class="today-schedule-list" id="todayScheduleList">
                </div>
            </section>
        </aside>
        </div>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <script>
       document.addEventListener('DOMContentLoaded', () => {
    // --- Utility Functions ---
    const getStorage = (key) => {
        try {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : [];
        } catch (e) {
            console.error("Error reading from localStorage", key, e);
            return [];
        }
    };
    const setStorage = (key, data) => {
        try {
            localStorage.setItem(key, JSON.stringify(data));
            console.log(`Data for key '${key}' saved to localStorage.`);
        } catch (e) {
            console.error("Error writing to localStorage", key, e);
        }
    };
    const getNextId = (arr) => arr.length > 0 ? Math.max(...arr.map(item => item.id)) + 1 : 1;

    // --- Data Management ---
    let schedules = getStorage('schedules');

    // Helper function to get local YYYY-MM-DD date string without timezone shift
    function getLocalDateString(date) {
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // Optional: Initialize dummy data if storage is empty, based on current date
    if (schedules.length === 0) {
        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth();
        const day = today.getDate();

        schedules = [
            { id: 1, title: "Daily Standup", date: getLocalDateString(new Date(year, month, day)), startTime: "09:00", endTime: "09:15", statusColor: 'blue' },
            { id: 2, title: "Client Meeting", date: getLocalDateString(new Date(year, month, day)), startTime: "10:00", endTime: "11:00", statusColor: 'green' },
            { id: 3, title: "Project Review", date: getLocalDateString(new Date(year, month, day + 1)), startTime: "14:00", endTime: "15:00", statusColor: 'purple' }
        ];
        setStorage('schedules', schedules);
    }

    // --- DOM Elements ---
    const scheduleListEl = document.getElementById('scheduleList');
    const scheduleForm = document.getElementById('scheduleForm');
    const formTitle = document.getElementById('formTitle');
    const scheduleIdInput = document.getElementById('scheduleId');
    const titleInput = document.getElementById('title');
    // Elements for custom date/time pickers
    const dateDisplay = document.getElementById('dateDisplay');
    const dateInputHidden = document.getElementById('dateInput');
    const startTimeDisplay = document.getElementById('startTimeDisplay');
    const startTimeInputHidden = document.getElementById('startTimeInput');
    const endTimeDisplay = document.getElementById('endTimeDisplay');
    const endTimeInputHidden = document.getElementById('endTimeInput');

    const statusColorSelect = document.getElementById('statusColor');
    // KOREKSI: Gunakan saveScheduleButton karena ini adalah tombol submit sebenarnya
    const saveScheduleButton = document.getElementById('saveScheduleButton');
    const cancelEditButton = document.getElementById('cancelEditButton');
    const refreshListButton = document.getElementById('refreshListButton');
    const openAddScheduleModalButton = document.getElementById('openAddScheduleModalButton');
    const addScheduleModal = document.getElementById('addScheduleModal');
    const closeAddScheduleModalButton = document.getElementById('closeAddScheduleModalButton');

    // --- Sidebar and Calendar Elements (needed if schedule.html is standalone) ---
    const dashboardContainer = document.getElementById('dashboardContainer');
    const mobileMenuToggle = document.getElementById('mobileMenuToggle');
    // const sidebarLeft = document.getElementById('sidebarLeft'); // Ini tidak ada di HTML Anda
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    // const sidebarCloseButton = document.getElementById('sidebarCloseButton'); // Ini tidak ada di HTML Anda

    const currentMonthYearHeader = document.getElementById('currentMonthYear');
    const calendarGridEl = document.getElementById('calendarGrid');
    const prevMonthBtn = document.getElementById('prevMonthBtn');
    const nextMonthBtn = document.getElementById('nextMonthBtn');
    let currentCalendarDate = new Date();
    const todayScheduleList = document.getElementById('todayScheduleList');


    // --- Helper Functions ---
    function formatTimeRange(start, end) {
        if (!start || !end) return '';
        return `${start} - ${end}`;
    }

    function formatDateDisplay(isoDateString) {
        if (!isoDateString) return '';
        try {
            const date = new Date(isoDateString);
            return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        } catch (e) {
            console.error("Invalid date string for formatting:", isoDateString, e);
            return isoDateString;
        }
    }

    function setupPickerInput(displayEl, hiddenInputEl) {
        if (!displayEl || !hiddenInputEl) return;

        // Set initial display value if hidden input already has a value
        if (hiddenInputEl.value) {
            if (hiddenInputEl.type === 'date') {
                displayEl.value = formatDateDisplay(hiddenInputEl.value);
            } else if (hiddenInputEl.type === 'time') {
                displayEl.value = hiddenInputEl.value;
            }
        }

        displayEl.addEventListener('click', () => {
            hiddenInputEl.showPicker();
        });

        hiddenInputEl.addEventListener('change', () => {
            if (hiddenInputEl.type === 'date') {
                displayEl.value = formatDateDisplay(hiddenInputEl.value);
            } else if (hiddenInputEl.type === 'time') {
                displayEl.value = hiddenInputEl.value;
            }
        });
    }

    function renderSchedules() {
        scheduleListEl.innerHTML = '';
        if (schedules.length === 0) {
            scheduleListEl.innerHTML = '<p class="empty-list-message">No schedules added yet.</p>';
            return;
        }

        schedules.sort((a, b) => {
            const dateA = new Date(`${a.date}T${a.startTime}`);
            const dateB = new Date(`${b.date}T${b.startTime}`);
            return dateA - dateB;
        });

        schedules.forEach((schedule) => {
            const div = document.createElement('div');
            div.className = 'schedule-item';
            div.innerHTML = `
                <div class="schedule-item-indicator ${schedule.statusColor || 'blue'}"></div>
                <div class="schedule-item-content">
                    <div class="title">${schedule.title}</div>
                    <div class="time"><i class='bx bx-calendar'></i> ${formatDateDisplay(schedule.date)} | <i class='bx bx-time'></i> ${formatTimeRange(schedule.startTime, schedule.endTime)}</div>
                </div>
                <div class="schedule-item-actions">
                    <button type="button" class="edit-schedule-btn" data-id="${schedule.id}"><i class='bx bx-edit-alt'></i></button>
                    <button type="button" class="delete-schedule-btn" data-id="${schedule.id}"><i class='bx bx-trash'></i></button>
                </div>
            `;
            scheduleListEl.appendChild(div);
        });
        renderCalendar(currentCalendarDate); // Refresh calendar highlight
        renderTodaySchedule(currentCalendarDate); // Refresh today's schedules
    }

    // Function to update form buttons and title based on mode
    function updateFormMode(isEditMode) {
        if (formTitle) formTitle.textContent = isEditMode ? 'Edit Schedule' : 'Add New Schedule';
        if (saveScheduleButton) saveScheduleButton.textContent = isEditMode ? 'Save Changes' : 'Add Schedule';
        if (cancelEditButton) cancelEditButton.style.display = isEditMode ? 'inline-block' : 'none';
    }

    function resetForm() {
        scheduleForm.reset();
        scheduleIdInput.value = '';
        dateDisplay.value = ''; // Clear display fields
        startTimeDisplay.value = '';
        endTimeDisplay.value = '';
        statusColorSelect.value = 'blue';
        updateFormMode(false); // Reset buttons to Add mode
    }

    // --- Event Handlers ---
    scheduleForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const id = scheduleIdInput.value;
        const title = titleInput.value.trim();
        const date = dateInputHidden.value;
        const startTime = startTimeInputHidden.value;
        const endTime = endTimeInputHidden.value;
        const statusColor = statusColorSelect.value;

        if (!title || !date || !startTime || !endTime || !statusColor) {
            alert('Please fill in all fields.');
            return;
        }

        if (id && id !== '') { // EDIT MODE
            const scheduleIndex = schedules.findIndex(s => s.id === parseInt(id));
            if (scheduleIndex > -1) {
                schedules[scheduleIndex] = {
                    ...schedules[scheduleIndex], // Keep existing properties if any
                    title, date, startTime, endTime, statusColor
                };
                setStorage('schedules', schedules);
                alert('Schedule updated successfully!');
            } else {
                console.warn('Schedule ID not found in schedules array for update.');
                alert('Error: Schedule not found for update.');
            }
        } else { // ADD MODE
            const newSchedule = {
                id: getNextId(schedules),
                title, date, startTime, endTime, statusColor
            };
            schedules.push(newSchedule);
            setStorage('schedules', schedules);
            alert('Schedule added successfully!');
        }

        renderSchedules();
        addScheduleModal.style.display = 'none'; // Hide modal
        resetForm(); // Reset form fields and buttons
    });

    scheduleListEl.addEventListener('click', (e) => {
        let editBtn = e.target.closest('.edit-schedule-btn');
        if (editBtn) {
            const idToEdit = parseInt(editBtn.dataset.id);
            const scheduleToEdit = schedules.find(s => s.id === idToEdit);

            if (scheduleToEdit) {
                updateFormMode(true); // Set form to Edit mode

                scheduleIdInput.value = scheduleToEdit.id;
                titleInput.value = scheduleToEdit.title;
                dateInputHidden.value = scheduleToEdit.date;
                startTimeInputHidden.value = scheduleToEdit.startTime;
                endTimeInputHidden.value = scheduleToEdit.endTime;
                statusColorSelect.value = scheduleToEdit.statusColor || 'blue';

                // Manually trigger change event for display inputs to update their values
                dateInputHidden.dispatchEvent(new Event('change'));
                startTimeInputHidden.dispatchEvent(new Event('change'));
                endTimeInputHidden.dispatchEvent(new Event('change'));

                addScheduleModal.style.display = 'flex'; // Show modal
            }
            return; // Exit handler after processing edit
        }

        const deleteBtn = e.target.closest('.delete-schedule-btn');
        if (deleteBtn) {
            const idToDelete = parseInt(deleteBtn.dataset.id);
            if (confirm('Are you sure you want to delete this schedule?')) {
                schedules = schedules.filter(s => s.id !== idToDelete);
                setStorage('schedules', schedules);
                renderSchedules();
                alert('Schedule deleted successfully!');
                resetForm(); // Reset form if an item was deleted (though not strictly necessary)
            }
            return; // Exit handler after processing delete
        }
    });

    if (cancelEditButton) {
        cancelEditButton.addEventListener('click', () => {
            addScheduleModal.style.display = 'none'; // Hide modal
            resetForm(); // Reset form fields and buttons
        });
    }

    // Show modal when Add Schedule button clicked
    if (openAddScheduleModalButton) {
        openAddScheduleModalButton.addEventListener('click', () => {
            console.log('Button "Add Schedule" clicked.');
            addScheduleModal.style.display = 'flex';
            resetForm(); // Ensure form is in add mode when opening
        });
    }

    // Hide modal when close button clicked
    if (closeAddScheduleModalButton) {
        closeAddScheduleModalButton.addEventListener('click', () => {
            console.log('Modal close button clicked.');
            addScheduleModal.style.display = 'none';
            resetForm();
        });
    }

    // Hide modal when clicking outside the form container
    if (addScheduleModal) {
        addScheduleModal.addEventListener('click', (e) => {
            if (e.target === addScheduleModal) {
                addScheduleModal.style.display = 'none';
                resetForm();
                console.log('Clicked outside modal, modal hidden.');
            }
        });
    }

    // --- Initial Render ---
    renderSchedules();

    // Initial setup for date/time pickers
    setupPickerInput(dateDisplay, dateInputHidden);
    setupPickerInput(startTimeDisplay, startTimeInputHidden);
    setupPickerInput(endTimeDisplay, endTimeInputHidden);

    // --- Right Sidebar Calendar Functionality ---
    function renderCalendar(date) {
        if (!currentMonthYearHeader || !calendarGridEl) return;
        currentMonthYearHeader.textContent = date.toLocaleString('en-US', { month: 'long', year: 'numeric' });
        calendarGridEl.innerHTML = '';

        const weekdays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        weekdays.forEach(day => {
            const weekdayEl = document.createElement('div');
            weekdayEl.classList.add('calendar-weekday');
            weekdayEl.textContent = day;
            calendarGridEl.appendChild(weekdayEl);
        });

        const year = date.getFullYear();
        const month = date.getMonth();

        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const startDayIndex = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;

        const daysInMonth = new Date(year, month + 1, 0).getDate();

        for (let i = 0; i < startDayIndex; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.classList.add('calendar-day', 'inactive');
            calendarGridEl.appendChild(emptyDay);
        }

        const today = new Date();
        const todayDateString = today.toISOString().split('T')[0];

        for (let day = 1; day <= daysInMonth; day++) {
            const dayElement = document.createElement('div');
            dayElement.classList.add('calendar-day');
            dayElement.textContent = day;

            const currentDate = new Date(year, month, day);
        // Helper function to get local YYYY-MM-DD date string without timezone shift
        function getLocalDateString(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Normalize date string to local YYYY-MM-DD format for comparison
        const currentDayDateString = getLocalDateString(currentDate);

        if (currentDayDateString === todayDateString) {
            dayElement.classList.add('today');
        }

        // Check schedules with normalized date strings
        const hasSchedule = schedules.some(s => {
            if (!s.date) return false;
            const scheduleDate = new Date(s.date);
            const scheduleDateString = getLocalDateString(scheduleDate);
            return scheduleDateString === currentDayDateString;
        });
            if (hasSchedule) {
                dayElement.classList.add('highlighted');
            }

            // Add circle/dot indicator for real-time today date
            const realToday = new Date();
            const realTodayString = getLocalDateString(realToday);
            if (currentDayDateString === realTodayString) {
                const dot = document.createElement('span');
                dot.classList.add('today-dot-indicator');
                dayElement.appendChild(dot);
            }

            calendarGridEl.appendChild(dayElement);
        }
    }

    function renderTodaySchedule(date) {
        if (!todayScheduleList) return;
        todayScheduleList.innerHTML = '';
        const todayDateString = date.toISOString().split('T')[0];
        const relevantSchedules = schedules.filter(s => s.date && s.date.split('T')[0] === todayDateString);

        if (relevantSchedules.length === 0) {
            todayScheduleList.innerHTML = '<p class="empty-list-message" style="text-align: center; color: var(--text-light);">No schedules for today.</p>';
            return;
        }

        relevantSchedules.forEach(schedule => {
            const scheduleItem = document.createElement('div');
            scheduleItem.classList.add('schedule-item');
            scheduleItem.innerHTML = `
                <div class="schedule-item-indicator ${schedule.statusColor || 'blue'}"></div>
                <div class="schedule-item-content">
                    <h4>${schedule.title}</h4>
                    <p>${schedule.description || ''}</p>
                    <div class="schedule-item-time">
                        <i class='bx bx-time'></i>
                        ${schedule.startTime} - ${schedule.endTime}
                    </div>
                </div>
            `;
            todayScheduleList.appendChild(scheduleItem);
        });
    }

    // Calendar Navigation for right sidebar
    if (prevMonthBtn) {
        prevMonthBtn.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderCalendar(currentCalendarDate);
            renderTodaySchedule(currentCalendarDate);
        });
    }
    if (nextMonthBtn) {
        nextMonthBtn.addEventListener('click', () => {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderCalendar(currentCalendarDate);
            renderTodaySchedule(currentCalendarDate);
        });
    }

    // Initial renders for right sidebar calendar and today's schedule
    renderCalendar(currentCalendarDate);
    renderTodaySchedule(currentCalendarDate);


    // --- Event Listeners for Sidebar Left (mobile toggle) ---
    if (mobileMenuToggle && dashboardContainer) {
        mobileMenuToggle.addEventListener('click', () => {
            dashboardContainer.classList.toggle('sidebar-open');
        });
    }
    if (sidebarOverlay && dashboardContainer) {
        sidebarOverlay.addEventListener('click', () => {
            dashboardContainer.classList.remove('sidebar-open');
        });
    }
    // if (sidebarCloseButton && dashboardContainer) { // This element is not in your HTML
    //     sidebarCloseButton.addEventListener('click', () => {
    //         dashboardContainer.classList.remove('sidebar-open');
    //     });
    // }

    // Ensure initial state of mobile sidebar
    if (dashboardContainer && window.innerWidth <= 768) {
        dashboardContainer.classList.remove('sidebar-open');
    }
});
    </script>
</body>
</html>